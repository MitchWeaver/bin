#!/bin/sh -rx
#
# http://github.com/mitchweaver/bin
#
# open firefox in a restricted environment
#

# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
# First run initialization
# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
# create the restricted user if it doesn't exist
userinfo -e _brws || doas useradd -m -s /sbin/nologin _brws

# hardcode user-dirs.dirs as we clear the environment later with env -i
#
# * use ~/Downloads for unveil(2)
# * use /tmp/brws_cache as not to store items on disk
if [ ! -f /home/_brws/.config/user-dirs.dirs ] ; then
    doas -u _brws mkdir -p /home/_brws/.config
    printf '%s\n%s\n' 'XDG_DOWNLOAD_DIR=${HOME}/Downloads' \
                      'XDG_CACHE_HOME=/tmp/brws_cache' | \
    doas -u _brws tee /home/_brws/.config/user-dirs.dirs
fi

# download hardened user.js if it doesn't exist
# see: http://github.com/ghacksuserjs/ghacks-user.js
if [ ! -f /home/_brws/.mozilla/user.js ] ; then
    mkdir -p /home/_brws/.mozilla
    curl -sL \
        https://raw.githubusercontent.com/ghacksuserjs/ghacks-user.js/master/user.js | \
        doas -u _brws tee /home/_brws/.mozilla/user.js
fi

# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
# Normal operation
# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
case $1 in
    */*|*.*)
        # we are given a link, go to it
        ;;
    '')
        # no args given, set homepage
        set -- 'https://start.duckduckgo.com/html'
        ;;
    *)
        # we are given search terms
        set -- "https://duckduckgo.com/html?q=$(echo "$*" | tr ' ' '+')"
esac

exec env -i \
doas -u _brws /usr/local/bin/firefox \
    --display=${DISPLAY:-:0} \
    --class=brws \
    -- "$*"

# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
# recommended flags if using chromium/iridium:
# --jitless
# --disable-features=WebAssembly,AsmJsToWebAssembly,WebAssemblyStreaming
