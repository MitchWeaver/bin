#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# get current song from mpvc
#

pgrep -x mpv >/dev/null || exit 1

# check if playing via ytdl
if pgrep -f '(mpv.*.http)' >/dev/null ; then
    song="$(mpvc -f '%artist% - %title%' 2>/dev/null)"
    case "$song" in
        *'N/A'*|'_ -'*|*' - _'|*%title%)
            song="$(mpvc -f '%path%' 2>/dev/null)"
    esac
    # if can't extract song from ytdl, see if we're playing through mus
    # --- if so we can use its stored $artist and $album vars
    if ! echo "$song" | grep -F ' - ' >/dev/null ; then
        if pgrep mus >/dev/null ; then
            . "$(mus file)"
            song="$artist - $album"
        fi
    fi
# otherwise we're playing a local file
else
    # attempt to get info from embedded tags
    song="$(mpvc -f \"%artist% - %title%\" 2>/dev/null)"

    # if not tagged, we must gather via file path
    if echo $song | grep 'N/A' >/dev/null ; then

        song=$(mpvc -f '%title%' 2>/dev/null)

        # chop off extension and preceding N/A
        song=${song%.${song##*.}}
    fi
fi

echo $song
