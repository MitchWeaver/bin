#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# ifconfig / wpa_supplicant wrapper
#

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    sudo -E $0 "$@"
    exit $?
fi

msg() { >&2 echo "--> $*" ; }

scripts=/home/mitch/bin/net

int="$($scripts/interface)"

msg "Using interface: $int"

for i in wpa_supplicant dhcpcd ; do
    pgrep -F $i && pkill -9 $i
done >/dev/null 2>&1

ifconfig $int down >/dev/null
ifconfig $int up   >/dev/null

# determine correct wpa_sup driver
case $int in
    wl*) driv=nl80211 ;;
    eth*|enp*) driv=wired ;;
    *) driv=wext
esac

wpa_supplicant \
    -c /etc/wpa_supplicant.conf \
    -i $int \
    -D $driv \
    >/var/log/wpa_supplicant.log 2>&1 &

sleep 1

dhcpcd -q -C resolv.conf $int >/dev/null
dhcpcd -q -C resolv.conf $int >/dev/null

echo 'nameserver 8.8.8.8' >/etc/resolv.conf
