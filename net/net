#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# ifconfig / wpa_supplicant wrapper (openbsd)
#

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    doas $0 "$@"
    exit $?
fi

msg() { >&2 echo "--> $*" ; }

scripts=/home/alan/bin/net

if [ "$1" ] ; then
    int="$1"
else
    int="$($scripts/interface)"
fi

msg "Using interface: $int"

ifconfig $int up   >/dev/null

for i in wpa_supplicant dhclient ; do
    pgrep $i && pkill -9 $i
done >/dev/null 2>&1

case $int in
    iwn*)
        driv=openbsd
        ;;
    em0)
        driv=wired
esac

for path in /usr/local/bin /usr/local/sbin /usr/bin ; do
    [ -x $path/wpa_supplicant ] && break
done

$path/wpa_supplicant \
    -c /etc/wpa_supplicant.conf \
    -i $int \
    -D $driv \
    >/var/log/wpa_supplicant.log 2>&1 & 

sleep 5

if [ -f /etc/hostname.$int ] ; then
    sh /etc/netstart $int
else
    dhclient $int
fi

echo "nameserver $(/home/alan/bin/net/dns)"  >/etc/resolv.conf
