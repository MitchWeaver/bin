#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# ifconfig / wpa_supplicant wrapper (openbsd)
#

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    doas $0 "$@"
    exit $?
fi

[ "$1" ] || set urtwn0

echo "Using interface: $1"
ifconfig $1 up >/dev/null

pkill -9 wpa_supplicant dhclient

log=/var/log/wpa_supplicant.log
/usr/local/sbin/wpa_supplicant \
    -c /etc/wpa_supplicant.conf \
    -i $1 \
    -D openbsd \
    >$log 2>&1 & 

echo "Waiting for authentication..."
max=15
c=0
while [ $c -le $max ] ; do
    if grep 'auth.*.complete' $log >/dev/null ; then
        break
    else
        c=$(( $c + 1 ))
        sleep 1
    fi
done

sh /etc/netstart $1

sleep 3
cp -f /etc/resolv.conf.keep /etc/resolv.conf
