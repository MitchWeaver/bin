#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# ifconfig / wpa_supplicant wrapper (openbsd)
#

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    doas $0 "$@"
    exit $?
fi

msg() { >&2 echo "--> $*" ; }

scripts=/home/alan/bin/net

if [ "$1" ] ; then
    int="$1"
else
    int="$($scripts/interface)"
fi

msg "Using interface: $int"

# ifconfig $int down >/dev/null
ifconfig $int up   >/dev/null

for i in wpa_supplicant dhclient ; do
    pgrep $i && pkill -9 $i
done >/dev/null 2>&1

case $int in
    iwn*|urtwn*) driv=openbsd ;;
    em0)  driv=wired
esac

/usr/local/sbin/wpa_supplicant \
    -c /etc/wpa_supplicant.conf \
    -i $int \
    -D $driv \
    >/var/log/wpa_supplicant.log 2>&1 & 

sleep 3

if [ -f /etc/hostname.$int ] ; then
    if sh /etc/netstart $int ; then
        sleep 5
        echo "nameserver $($scripts/dns)"  >/etc/resolv.conf
        echo "lookup file bind" >>/etc/resolv.conf
    fi
fi 
