#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# openvpn wrapper for ease of use 
#

OPENVPN_DIR=/etc/openvpn
LOCATION_DIR=/etc/openvpn/locations

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    if type doas > /dev/null ; then
        doas $0 "$@"
    else
        sudo -E $0 "$@"
    fi
    exit $?
fi

cd "$OPENVPN_DIR" || exit 1

# in case we have TUN as a module and not builtin
[ $(uname) = Linux ] && modprobe tun 2>/dev/null

usage() {
    echo "Options: off, [loc], locs, random"
    exit 1
}
[ "$1" ] || usage

case "$1" in
    *off)
        pkill -x openvpn
        rm -f /tmp/vpn 2>/dev/null
        exit
        ;;
    *locs) 
        ls "$LOCATION_DIR"
        exit
        ;;
    *random|-r|r)
        cd "$LOCATION_DIR"
        loc="$(ls *.ovpn | { sort -R || shuf ; } 2> /dev/null | head -n 1)"
        loc="${loc%.*}"
        cd "$OPENVPN_DIR"
        ;;
    -h|help) usage
        ;;
    *) loc="$(basename "$(find "$LOCATION_DIR" -type f -iname "*$1*" | sed 's|.ovpn||')")"
esac

[ -z "$loc" ] && exit 1
echo "Using location: $loc"

pgrep -x openvpn >/dev/null && pkill -x openvpn
openvpn --daemon --config "$LOCATION_DIR"/"$loc.ovpn"

echo "nameserver $(/home/alan/bin/net/dns)"  >/etc/resolv.conf
echo "$loc" >/tmp/vpn && chmod 644 /tmp/vpn
