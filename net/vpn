#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# openvpn wrapper for ease of use 
#

dir=/etc/openvpn
locs=/etc/openvpn/locations

# if not running as root, restart script
if [ $(id -u) -ne 0 ] ; then
    doas $0 "$@"
    exit $?
fi

cd "$dir" || exit 1

case "$1" in
    *off)
        pkill -x openvpn
        rm -f /tmp/vpn 2>/dev/null
        ;;
    *loc)
        ps -U root | grep openvpn | sed -e 's|.*.\/||' -e 's|\.ovpn||' | grep -v grep
        ;;
    *locs) 
        ls "$locs"
        ;;
    *random|-r|r)
        cd "$locs"
        loc="$(ls *.ovpn | sort -R | head -n 1)"
        loc="${loc%.*}"
        cd "$dir"
        ;;
    *) loc="$(basename "$(find "$locs" -type f -iname "*$1*" | sed 's|.ovpn||')")"
esac

[ "$loc" ] || exit 1

pkill -x openvpn
openvpn \
    --connect-retry 3 3 \
    --config \
    "$locs"/"$loc.ovpn" >/var/log/openvpn.log 2>&1 &

[ $? -eq 0 ] && echo "Using location: $loc"
