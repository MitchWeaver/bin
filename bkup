#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# local backup to my nfs
#
# shellcheck disable=2086
#

# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/
# ==== MAP ====
# #### pi
# * 2TB --- VIDEO (anime+movies+tv)
# * 1TB --- MUSIC + FILES
# #### NAS
# * 500GB_1 --- MOVIES + TV BACKUP
# * 500GB_2 --- ANIME BACKUP
# * 500GB_3 --- GAMES BACKUP
# * 160GB ----- MUSIC + FILES BACKUP
# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/

# checks if a symlink or not a directory
chk() {
    if [ -L "$1" ] || [ ! -d "$1" ] ; then
        return 1
    fi
}

rsync='rsync -rtvuh --progress --delete --partial'
rem=pi

# backup local files to main drives
chk ~/bks && $rsync ~/bks/ $rem:/mnt/1TB/bks &
chk ~/fil && $rsync ~/fil/ $rem:/mnt/1TB/fil &
chk ~/img && $rsync ~/img/ $rem:/mnt/1TB/img &
chk ~/gam && $rsync ~/gam/ $rem:/mnt/1TB/gam &
chk ~/src && $rsync ~/src/ $rem:/mnt/1TB/src &

# secondary backup of local files
chk ~/bks && $rsync ~/bks/ $rem:/mnt/160GB/bks &
chk ~/img && $rsync ~/img/ $rem:/mnt/160GB/img &
chk ~/fil && $rsync ~/fil/ $rem:/mnt/160GB/fil &
chk ~/src && $rsync ~/src/ $rem:/mnt/160GB/src &
chk ~/gam && $rsync ~/gam/ $rem:/mnt/500GB_3/gam &

wait

# secondary backup of remote files
{
    ssh $rem $rsync /mnt/2TB/vid/anime/  /mnt/500GB_2/anime
    ssh $rem $rsync /mnt/2TB/vid/movies/ /mnt/500GB_1/movies
    ssh $rem $rsync /mnt/2TB/vid/tv/     /mnt/500GB_1/tv
    ssh $rem $rsync /mnt/2TB/vid/misc/   /mnt/500GB_1/misc
} &

ssh $rem $rsync /mnt/1TB/mus/        /mnt/160GB/mus &

wait

>&2 echo "All done!"
