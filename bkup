#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# local backup to my nfs
#
# shellcheck disable=2086
#

# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/
# ==== MAP ====
# /nfs/storage              2TB   - main storage
# /nfs/backup/anime-bkup    500GB - anime
# /nfs/backup/shows-bkup    500GB - movies+tv
# /nfs/backup/files-bkup    500GB - files+music+vms+isos
# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/

# checks if a symlink or not a directory
chk() {
    if [ -L "$1" ] || [ ! -d "$1" ] ; then
        return 1
    fi
}

rsync='rsync -rtvuh --progress --delete --partial'
rem=nfs

# backup local files to main storage
chk ~/bin && $rsync ~/bin/ $rem:/nfs/storage/bin
chk ~/bks && $rsync ~/bks/ $rem:/nfs/storage/bks
chk ~/env && $rsync ~/env/ $rem:/nfs/storage/env
chk ~/fil && $rsync ~/fil/ $rem:/nfs/storage/fil
chk ~/gam && $rsync ~/gam/ $rem:/nfs/storage/gam
chk ~/img && $rsync ~/img/ $rem:/nfs/storage/img
chk ~/mus && $rsync ~/mus/ $rem:/nfs/storage/mus
chk ~/src && $rsync ~/src/ $rem:/nfs/storage/src

# secondary backup
chk ~/bin && $rsync ~/bin/ $rem:/nfs/backup/files-bkup/bin
chk ~/bks && $rsync ~/bks/ $rem:/nfs/backup/files-bkup/bks
chk ~/env && $rsync ~/env/ $rem:/nfs/backup/files-bkup/env
chk ~/fil && $rsync ~/fil/ $rem:/nfs/backup/files-bkup/fil
chk ~/gam && $rsync ~/gam/ $rem:/nfs/backup/files-bkup/gam
chk ~/img && $rsync ~/img/ $rem:/nfs/backup/files-bkup/img
chk ~/mus && $rsync ~/mus/ $rem:/nfs/backup/files-bkup/mus
chk ~/src && $rsync ~/src/ $rem:/nfs/backup/files-bkup/src

# secondary backup of video
ssh $rem $rsync /nfs/storage/vid/anime/   /nfs/backup/anime-bkup
ssh $rem $rsync /nfs/storage/vid/movies/  /nfs/backup/shows-bkup
ssh $rem $rsync /nfs/storage/vid/tv/      /nfs/backup/shows-bkup
ssh $rem $rsync /nfs/storage/vid/misc/    /nfs/backup/shows-bkup

>&2 echo "All done!"
