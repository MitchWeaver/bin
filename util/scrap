#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# Scrap - SCReen cAPture
#
# deps: slop, curl, feh, xsel ... and:
#
#       xscreenshot (with crop patch) + farbfeld
#       OR
#       imagemagick
#

usage() {
cat << EOF
scrap - SCReen cAPture
----------------------------
-u  -  upload file to 0x0.st
-o  -  custom output path
-n  -  just import, don't select
-f  -  open capture with feh
EOF
exit
}

while [ "$1" ] ; do
    case $1 in
        -o) file="$2" ; [ -z "$file" ] && file="${HOME}" ;;
        -n) nocrop=true ;;
        -u) upload=true ;;
        -f) open=true   ;;
        *)  usage
    esac
    shift
done

pgrep slop >/dev/null && exit 1

if [ -z "$file" ] ; then
    dir=${HOME}/tmp/scrap
    mkdir -p $dir
    count=0
    file="$dir/scrap-$count.png"
    while [ -f "$file" ] ; do
        count=$(($count + 1))
        file="$dir/scrap-$count.png"
    done
fi

if type xscreenshot >/dev/null ; then
    [ "$nocrop" ] || set -- -g "$(slop -q -o -f '%wx%h+%x+%y')"
    xscreenshot $@ | ff2png > "$file"
else
    [ "$nocrop" ] || set -- -crop "$(slop -q -o -f '%wx%h+%x+%y')"
    import -quiet -window root $@ "$file"
fi

ln -sf "$file" /tmp/scrap.png
ln -sf "$file" ${HOME}/tmp/scrap.png

if [ "$upload" ] ; then
    set -- $(curl -sF "file=@$file" 0x0.st || notify-send "failed to upload")
    echo "$1"
    for clip in ip ib is ; do
        echo "$1" | xsel -$clip
    done
fi
[ "$open" ] && feh "$file" &
