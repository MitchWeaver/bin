#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# Scrap - SCReen cAPture
#
# deps: xrectsel, imagemagick
# optional: curl, opn, xsel
#
# xrectsel can be found here: http://github.com/mitchweaver/xrectsel
#

usage() {
cat << EOF
scrap - SCReen cAPture
----------------------------
-u  -  upload file to 0x0.st
-n  -  just import, don't select
-f  -  open capture afterwards
EOF
exit
}

while [ "$1" ] ; do
    case $1 in
        -n) nocrop=true ;;
        -u) upload=true ;;
        -f) open=true   ;;
        *)  usage
    esac
    shift
done

pgrep -x xrectsel >/dev/null && exit 1

dir=${XDG_CACHE_HOME:-~/.config}/scrap
mkdir -p $dir
set -- $(ls $dir | wc -l)
file=$dir/scrap-$1-$$.png
set -- "$file"
[ "$nocrop" ] || set -- -crop "$(xrectsel -f '%wx%h+%x+%y')" "$file"
xwd -silent -root | convert xwd:- "$@"
ln -sf "$file" /tmp/scrap.png

if [ "$upload" ] ; then
    # this would just be `curl | tee /dev/tty | clip -i`...
    # but annoyingly this doesn't work if called from dmenu
    link=$(curl -sF "file=@$file" 0x0.st || \
        notify-send "failed to upload: $file")
    echo "$link" | clip -i
    echo "$link"
fi
[ "$open" ] && opn "$file" &
