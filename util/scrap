#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# Scrap - SCReen cAPture
#
# deps: slop, imagemagick, curl, feh, xsel
#

usage() {
cat << EOF
scrap - SCReen cAPture
----------------------------
-u  -  upload file to 0x0.st
-o  -  custom output path
-n  -  just import, don't select
-f  -  open capture with feh
-c  -  copy image to ${HOME}
EOF
exit
}

while [ $# -gt 0 ] ; do
    case $1 in
        -o) shift ; file="$1" ;;
        -n) nocrop=true       ;;
        -u) upload=true       ;;
        -f) open=true         ;;
        -c) copy=true         ;;
        *)  usage
    esac
    shift
done

pgrep slop > /dev/null && exit 1

if [ -z "$file" ] ; then
    dir=${HOME}/tmp/scrap
    mkdir -p $dir
    file="$dir/scrap-$(ls $dir | wc -l).png"
elif [ -d "$file" ] ; then
    dir="$file"
    file="$dir/scrap-$(date).png"
fi

[ "$nocrop" ] || set -- -crop "$(slop -q -o -f '%wx%h+%x+%y')"

import -quiet -window root "$@" "$file"
ln -sf "$file" /tmp/scrap.png

if [ "$upload" ] ; then
    echo $(curl -sF "f:1=<$file" ix.io).png | xsel
    xsel -o | xsel -ib
    xsel -o | xsel -is
fi
[ "$open" ] && feh "$file" &
[ "$copy" ] && cp "$file" "${HOME}/scrap-$(date).png"
