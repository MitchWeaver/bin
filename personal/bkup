#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# local backup to my nas
#
# shellcheck disable=2086
#

host=datahoarder
user=root
nfs=/mnt/array
rsync='rsync -rtvuh --progress --delete --partial --links --update'

# checks if a symlink or not a directory
chk() {
    if [ -L "$1" ] || [ ! -d "$1" ] ; then
        return 1
    fi
}

# backup local files to main storage
for dir in \
    bin files images snap src
do
    chk ~/$dir && $rsync ~/$dir/ $user@$host:$nfs/$dir
    chk ~/$dir && $rsync ~/$dir/ /mnt/2TB/$dir
done

# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
chk ~/.config && $rsync ~/.config/ $user@$host:$nfs/dot_config
chk ~/.local  && $rsync ~/.local/  $user@$host:$nfs/dot_local

chk ~/.config && $rsync ~/.config/ /mnt/2TB/dot_config
chk ~/.local  && $rsync ~/.local/  /mnt/2TB/dot_local
# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*

# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
chk /mnt/128GB_SSD && $rsync /mnt/128GB_SSD/ /mnt/2TB/games

for dir in games music videos storage ; do
    [ -d /mnt/2TB/$dir ] &&
    $rsync /mnt/2TB/$dir/ $user@$host:$nfs/$dir
done

# fix permissions for roku to access via minidlna
ssh "$user@$host" chmod -R 0755 $nfs/videos &
ssh "$user@$host" chmod -R 0755 $nfs/music &
wait
ssh "$user@$host" rc-service minidlna restart
# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
