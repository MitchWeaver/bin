#!/bin/sh -e
#
# http://github.com/mitchweaver/bin
#
# local backup to my nas
#
# shellcheck disable=2086
#

# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/
# ▞▀▖▐                  ▌              ▐  
# ▚▄ ▜▀ ▞▀▖▙▀▖▝▀▖▞▀▌▞▀▖ ▌  ▝▀▖▌ ▌▞▀▖▌ ▌▜▀ 
# ▖ ▌▐ ▖▌ ▌▌  ▞▀▌▚▄▌▛▀  ▌  ▞▀▌▚▄▌▌ ▌▌ ▌▐ ▖
# ▝▀  ▀ ▝▀ ▘  ▝▀▘▗▄▘▝▀▘ ▀▀▘▝▀▘▗▄▘▝▀ ▝▀▘ ▀ 
# /nfs/storage              2TB   - main storage
# /nfs/backup/anime-bkup    500GB - anime
# /nfs/backup/shows-bkup    500GB - movies+tv
# /nfs/backup/files-bkup    500GB - files+music+vms+isos
# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/

# checks if a symlink or not a directory
chk() {
    if [ -L "$1" ] || [ ! -d "$1" ] ; then
        return 1
    fi
}

bk() {
    printf '\n[*] Syncing %s to %s\n\n' "$1" "$2"
    $rsync "$1" "$2"
}

sec_bk() {
    printf '\n[*] Syncing %s to %s\n\n' "$1" "$2"
    ssh $rem $rsync \"$1\" \"$2\"
}

rsync='rsync -rtvuh --progress --delete --partial'
rem=datahoarder

# backup local files to main storage
chk ~/bin       && bk ~/bin/       $rem:/nfs/storage/bin
chk ~/Desktop   && bk ~/Desktop/   $rem:/nfs/storage/Desktop
chk ~/Documents && bk ~/Documents/ $rem:/nfs/storage/Documents
chk ~/Games     && bk ~/Games/     $rem:/nfs/storage/Games
chk ~/Music     && bk ~/Music/     $rem:/nfs/storage/Music
chk ~/Pictures  && bk ~/Pictures/  $rem:/nfs/storage/Pictures

# secondary backups
sec_bk /nfs/storage/bin/        /nfs/backup/files-bkup/bin
sec_bk /nfs/storage/Desktop/    /nfs/backup/files-bkup/Desktop
sec_bk /nfs/storage/Documents/  /nfs/backup/files-bkup/Documents
sec_bk /nfs/storage/Games/      /nfs/backup/files-bkup/Games
sec_bk /nfs/storage/Music/      /nfs/backup/files-bkup/Music
sec_bk /nfs/storage/Pictures/   /nfs/backup/files-bkup/Pictures

# bulk storage, ISOs, VMs, etc
sec_bk /nfs/storage/Storage/   /nfs/backup/files-bkup/Storage

# video
sec_bk /nfs/storage/Videos/anime/  /nfs/backup/anime-bkup
sec_bk /nfs/storage/Videos/movies/ /nfs/backup/shows-bkup/movies
sec_bk /nfs/storage/Videos/tv/     /nfs/backup/shows-bkup/tv
sec_bk /nfs/storage/Videos/misc/   /nfs/backup/shows-bkup/misc

# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/
# ▀▛▘▛▀▘▙▗▌▛▀▖
#  ▌ ▙▄ ▌▘▌▙▄▘
#  ▌ ▌  ▌ ▌▌  
#  ▘ ▀▀▘▘ ▘▘  
# my server is too slow to do VMs over nfs, for now just use
# the drive as backup for local ¯\_(ツ)_/¯
chk ~/Virtualization && bk ~/Virtualization/ $rem:/nfs/Virtualization
# -/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/

>&2 printf '\nAll done!\n'
